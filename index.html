<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        * {
            margin: 0;
        }
        body {
            background: black;
        }

        .mainContainer {
            display: grid;
            justify-items: center;
            position: absolute;
            top: 50%;
            right: 50%;
            transform: translate(50%, -50%);
        }
        .mainContainer > * {
            margin-top: 40px;
        }

        .showEndResult {
            height: 100px;
            width: 100px;
            color: white;
        }

        .showEndResult img {
            height: 100%;
            position: relative;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body>
    <div class="mainContainer">
        <div class="write">
            <input class="textSource" type="text" placeholder="Insira seu texto aqui...">
            <button class="send"> Enviar </button>
        </div>
        <div class="show">
            <div class="showEndResult"></div>
        </div>
    </div>
</body>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    var input = document.querySelector(".textSource");
    var show = document.querySelector(".showEndResult");

    var language = "pt";

    var textShowSpeed = 200;

    var alfabet;
    axios.get("/getTitles", {
            params: {
            lang: "alfabet"
        }
    }).
    then(res => alfabet = res.data);
    

    var imagesArr = [];


    document.querySelector(".send").addEventListener("click", async () => {
        if(!input.value) return

        var wordList;
        await axios.get("/getTitles", {
            params: {
                lang: language
            }
        }).
        then(res => wordList = res.data);
        

        // systems words: space, SW_error
        var wiritten = input.value.
            normalize("NFD").
            replace(/[\u0300-\u036f]/g, "").
            toLowerCase().
            replaceAll(" ", " SW_space ").
            split(" ");

        var dir = "./images/";
        var showList = [];
        wiritten.forEach(word => {
            var findWord = wordList.find(w => w == word);
            var findWordInAlfabe = alfabet.find(w => w == word);

            if(findWord){
                showList.push({
                    url: dir+language+"/"+findWord+".png",
                    time: findWord.length
                });

            } else if(findWordInAlfabe){
                showList.push({
                    url: dir+"alfabet/"+findWordInAlfabe+".png",
                    time: 1
                });

            } else {
                var writtenLetter = word.split("");
                
                writtenLetter.forEach(letter => {
                    var findLetter = alfabet.find(l => l == letter);

                    var url;
                    var time;
                    var error;
                    if(findLetter){
                        url = dir+"alfabet/"+findLetter+".png";
                        time = 1;
                    } else {
                        url = dir+"alfabet/"+"SW_error.png";
                        time = 4;
                        error = letter;
                    }
                    
                    showList.push({
                        url,
                        time,
                        error
                    });
                });
            }
        });

        loadImages(showList);
    });

    var imagesLoaded;
    const loadImages = (list) => {
        imagesArr = [];
        imagesLoaded = 0;

        list.forEach(image => {
            var img = new Image();
                img.src = image.url;
                img.onload = () => loadImage(list);
            
            imagesArr.push({
                img,
                time: image.time,
                error: image.error
            });
        });

        show.innerHTML = "Carregando imagens...";
    }

    var showingIndex;
    const loadImage = (arr) => {
        if(++imagesLoaded == arr.length){
            showingIndex = 0;
            showImages();
        }
    }

    const showImages = () => {
        var imgEl = imagesArr[showingIndex];
        show.innerHTML = "";
        show.append(imgEl.img);

        if(imgEl.error != undefined)
            show.append('Caractere "'+imgEl.error+'" nÃ£o existe no Banco de Dados!');

        setTimeout(() => {
            if(showingIndex < imagesArr.length){
                showImages();
            } else {
                show.innerHTML = "";
            }
        }, imgEl.time * textShowSpeed);
        showingIndex++;
    } 
</script>
</html>